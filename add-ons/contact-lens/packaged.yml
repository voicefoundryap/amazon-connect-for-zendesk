AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Parameters:
  pTargetEnvironment:
    Description: Name of your target environment (dev, UAT, prod, ...)
    Type: String
    Default: prod
  pConnectBucket:
    Description: S3 bucket name for your Connect data storage
    Type: String
    Default: connect-xyz
    AllowedPattern: (?=^.{3,63}$)(?!^(\d+\.)+\d+$)(^(([a-z0-9]|[a-z0-9][a-z0-9\-]*[a-z0-9])\.)*([a-z0-9]|[a-z0-9][a-z0-9\-]*[a-z0-9])$)
  pConnectMasterKeyId:
    Description: Key ID of your KMS customer managed key with alias connect-master-key
    Type: String
  pZendeskEmailID:
    Type: String
    Description: The Zendesk Admin Email ID for the selected Zendesk Instance
  pZendeskToken:
    Type: String
    Description: Zendesk Token with Admin privileges.This needs to be generated as
      a pre-requisite for this installation.
    NoEcho: true
  pZendeskURL:
    Type: String
    Description: Zendesk URL (https://<your-name>.zendesk.com).The Zendesk instance
      needs to be created as a pre-requisite for this installation.
    AllowedPattern: https://[a-zA-Z0-9-.]+.zendesk.com$
    ConstraintDescription: Endpoint must be a valid Zendesk Host URL. For example,
      https://voicefoundryap.zendesk.com
  pConnectURL:
    Type: String
    Description: Connect instance URL (either https://<connect-instance>.awsapps.com,
      or https://<connect-instance>.my.connect.aws).
    AllowedPattern: https://[a-zA-Z0-9-.]+.(awsapps.com|my.connect.aws)$
    ConstraintDescription: Endpoint must be a valid Connect instance URL.
  pTimeZone:
    Type: String
    Description: Time zone (eg. Australia/Sydney) to be used when linking to Connect
      Contact Trace Records. For a full list see https://en.wikipedia.org/wiki/List_of_tz_database_time_zones
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
    - Label:
        default: Amazon Connect Configuration
      Parameters:
      - pConnectBucket
      - pConnectMasterKeyId
      - pConnectURL
    - Label:
        default: Zendesk Configuration
      Parameters:
      - pZendeskURL
      - pZendeskToken
      - pZendeskEmailID
    - Label:
        default: Deployment Parameters
      Parameters:
      - pTargetEnvironment
      - pTimeZone
    ParameterLabels:
      pConnectBucket:
        default: Connect Bucket Name
      pConnectMasterKeyId:
        default: Connect Master Key Id
      pConnectURL:
        default: Connect Instance URL
      pZendeskURL:
        default: Zendesk URL
      pZendeskEmailID:
        default: Zendesk Admin Email ID
      pZendeskToken:
        default: Zendesk API Token
      pTargetEnvironment:
        default: Target Deployment Environment
      pTimeZone:
        default: CTR Time Zone
  AWS::ServerlessRepo::Application:
    Name: Contact-Lens-Analysis-for-Zendesk
    Description: Appends Amazon Contact Lens analysis to a corresponding Zendesk Support
      ticket. To be used with Amazon Connect app for Zendesk.
    Author: VoiceFoundry-APAC
    SpdxLicenseId: GPL-3.0-or-later
    LicenseUrl: s3://214558022353-connect-zendesk-ap-southeast-2/zendesk-add-ons/contact-lens//e62637ea8a114355b985fd86c9ffbd6e
    ReadmeUrl: s3://214558022353-connect-zendesk-ap-southeast-2/zendesk-add-ons/contact-lens//803b009a28d964c57d559c9f949a95f0
    Labels:
    - Connnect
    - Contact-Lens
    - Zendesk
    - Sentiment
    - Transcript
    HomePageUrl: https://github.com/voicefoundryap/amazon-connect-for-zendesk/add-ons/contact-lens
    SemanticVersion: '0.0.4'
    SourceCodeUrl: https://github.com/voicefoundryap/amazon-connect-for-zendesk/add-ons/contact-lens
Resources:
  tableZendeskRetries:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName:
        Fn::Sub: zendeskUpdateRetries-${pTargetEnvironment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
      - AttributeName: contactId
        AttributeType: S
      KeySchema:
      - AttributeName: contactId
        KeyType: HASH
      TimeToLiveSpecification:
        AttributeName: expires
        Enabled: true
  functionUpdateTicket:
    Type: AWS::Serverless::Function
    DependsOn: tableZendeskRetries
    Properties:
      FunctionName:
        Fn::Sub: contactLensZendeskUpdate-${pTargetEnvironment}
      Description: Triggered on upload of Contact Lens analysis to S3 bucket, it finds
        and updates the matching Zendesk support ticket
      Runtime: nodejs12.x
      Handler: index.handler
      CodeUri: s3://214558022353-connect-zendesk-ap-southeast-2/zendesk-add-ons/contact-lens//b8dc42d486cebb09d843c1462d389e3f
      Timeout: 240
      Policies:
      - AWSLambdaBasicExecutionRole
      - S3ReadPolicy:
          BucketName:
            Ref: pConnectBucket
      - KMSDecryptPolicy:
          KeyId:
            Ref: pConnectMasterKeyId
      - DynamoDBCrudPolicy:
          TableName:
            Ref: tableZendeskRetries
      Environment:
        Variables:
          CONTACT_LENS_BUCKET:
            Ref: pConnectBucket
          CONNECT_INSTANCE_URL:
            Ref: pConnectURL
          RETRIES_TABLE:
            Ref: tableZendeskRetries
          EXCLUSION_KEY: no-support-ticket
          INCLUSION_KEY: support-ticket
          EXPIRES_MINUTES: 20
          MAX_QUERY_LENGTH: 1024
          TIME_ZONE:
            Ref: pTimeZone
          ZD_EMAIL:
            Ref: pZendeskEmailID
          ZD_TOKEN:
            Ref: pZendeskToken
          ZD_URL:
            Ref: pZendeskURL
      Events:
        scheduledEvent:
          Type: Schedule
          Properties:
            Schedule: rate(5 minutes)
            Name:
              Fn::Sub: zendeskpRetrySchedule-${pTargetEnvironment}
            Description: invokes contactLensZendeskUpdate lambda which retries finding
              a matching support ticket
